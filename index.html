<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ESP32 Audio Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #0f172a;
    color: #e5e7eb;
    margin: 0;
    padding: 20px;
}

h1 {
    text-align: center;
}

.card {
    max-width: 600px;
    margin: auto;
    background: #020617;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 30px rgba(0,0,0,0.5);
}

input, button {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border-radius: 8px;
    border: none;
    font-size: 16px;
}

input {
    background: #020617;
    color: white;
    border: 1px solid #334155;
}

button {
    background: #2563eb;
    color: white;
    font-weight: bold;
}

button:disabled {
    background: #334155;
}

.log {
    background: black;
    padding: 10px;
    height: 200px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 13px;
    border-radius: 8px;
    border: 1px solid #334155;
}

.ok { color: #22c55e; }
.err { color: #ef4444; }
.info { color: #38bdf8; }
.warn { color: #facc15; }
</style>
</head>
<body>

<h1>üéß ESP32 WiFi Audio Player</h1>

<div class="card">

<label>üì° IP de l'ESP32 :</label>
<input id="ip" value="10.14.133.45">

<label>üåç URL du fichier audio RAW :</label>
<input id="audioUrl" value="https://mathieuduboy.github.io/voiture/test3.raw">

<button id="btn" onclick="start()">‚ñ∂Ô∏è Envoyer le son</button>

<h3>üìú Logs :</h3>
<div id="log" class="log"></div>

</div>

<script>
const logDiv = document.getElementById("log");
const btn = document.getElementById("btn");

function log(msg, cls="info") {
    const line = document.createElement("div");
    line.className = cls;
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logDiv.appendChild(line);
    logDiv.scrollTop = logDiv.scrollHeight;
}

async function start() {
    const ip = document.getElementById("ip").value.trim();
    const audioUrl = document.getElementById("audioUrl").value.trim();

    if (!ip || !audioUrl) {
        alert("IP ou URL manquante");
        return;
    }

    btn.disabled = true;
    log("üöÄ D√©but du process...");

    try {
        // 1) Test connexion ESP32
        log("üîå Test connexion ESP32...", "info");
        await fetch("http://" + ip + ":8081", { method: "OPTIONS" });
        log("‚úÖ ESP32 joignable", "ok");
    } catch (e) {
        log("‚ùå Impossible de contacter l'ESP32 : " + e, "err");
        btn.disabled = false;
        return;
    }

    let audioBuffer;

    try {
        // 2) T√©l√©charger l'audio
        log("‚¨áÔ∏è T√©l√©chargement de l'audio...", "info");
        const res = await fetch(audioUrl);
        if (!res.ok) throw new Error("HTTP " + res.status);
        audioBuffer = await res.arrayBuffer();
        log("‚úÖ Audio t√©l√©charg√© : " + audioBuffer.byteLength + " octets", "ok");
    } catch (e) {
        log("‚ùå Erreur t√©l√©chargement audio : " + e, "err");
        btn.disabled = false;
        return;
    }

    try {
        // 3) Envoi vers ESP32
        log("üì° Envoi du flux audio vers ESP32...", "info");
        const res = await fetch("http://" + ip + ":8081", {
            method: "POST",
            body: audioBuffer
        });
        log("‚úÖ Envoi termin√©", "ok");
    } catch (e) {
        log("‚ùå Erreur envoi vers ESP32 : " + e, "err");
        btn.disabled = false;
        return;
    }

    log("üéâ Termin√© !", "ok");
    btn.disabled = false;
}
</script>

</body>
</html>
