<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Trajet - ESP32</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        
        .status-connected {
            background: linear-gradient(45deg, var(--success), #2ecc71);
            color: white;
        }
        
        .status-disconnected {
            background: linear-gradient(45deg, var(--danger), #e67e22);
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--secondary), #2980b9);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        
        .btn-success {
            background: linear-gradient(45deg, var(--success), #229954);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        .trajet-info {
            background: linear-gradient(45deg, #34495e, #2c3e50);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .progress {
            height: 8px;
            border-radius: 10px;
        }
        
        .connection-status {
            font-size: 0.9em;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .auto-complete-list {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: calc(100% - 30px);
            border-radius: 0 0 10px 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .auto-complete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        
        .auto-complete-item:hover {
            background: #f8f9fa;
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 10px;
        }
        
        .trajet-stats {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid var(--secondary);
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <!-- En-tête -->
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <h1 class="card-title mb-3">
                            <i class="fas fa-road me-2"></i>Dashboard Trajet
                        </h1>
                        <p class="text-muted">Contrôlez votre trajet ESP32 en temps réel</p>
                        
                        <div class="d-flex justify-content-center align-items-center gap-3">
                            <div id="connectionStatus" class="connection-status status-disconnected">
                                <i class="fas fa-plug me-2"></i>Déconnecté
                            </div>
                            <div id="batteryLevel" class="connection-status" style="background: #95a5a6; color: white;">
                                <i class="fas fa-battery-half me-2"></i>N/A
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulaire de configuration -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Configuration du Trajet</h5>
                    </div>
                    <div class="card-body">
                        <form id="trajetForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ville de départ</label>
                                    <input type="text" id="villeDepart" class="form-control" placeholder="Saisir la ville de départ">
                                    <div id="autoCompleteDepart" class="auto-complete-list"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Ville d'arrivée</label>
                                    <input type="text" id="villeArrivee" class="form-control" placeholder="Saisir la ville d'arrivée">
                                    <div id="autoCompleteArrivee" class="auto-complete-list"></div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Temps total (minutes)</label>
                                    <input type="number" id="totalTime" class="form-control" placeholder="Durée totale" min="1" value="180">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Fréquence des pauses</label>
                                    <select id="pauseFrequency" class="form-select">
                                        <option value="30">Pause toutes les 30min</option>
                                        <option value="45">Pause toutes les 45min</option>
                                        <option value="60" selected>Pause toutes les 1h</option>
                                        <option value="90">Pause toutes les 1h30</option>
                                        <option value="120">Pause toutes les 2h</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Distance (km) - Optionnel</label>
                                    <input type="number" id="distance" class="form-control" placeholder="Distance en km">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Heure d'arrivée estimée</label>
                                    <input type="time" id="heureArrivee" class="form-control">
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" id="connectBtn" class="btn btn-primary me-md-2">
                                    <i class="fas fa-bluetooth-b me-2"></i>Connexion BLE
                                </button>
                                <button type="submit" id="sendBtn" class="btn btn-success" disabled>
                                    <i class="fas fa-paper-plane me-2"></i>Démarrer le Trajet
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Informations du trajet -->
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations du Trajet</h5>
                    </div>
                    <div class="card-body">
                        <div id="trajetInfo" class="text-center text-muted">
                            <i class="fas fa-road fa-3x mb-3"></i>
                            <p>Aucun trajet en cours</p>
                        </div>
                        
                        <div id="activeTrajet" style="display: none;">
                            <div class="trajet-stats">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <h6>Temps restant</h6>
                                        <h4 id="tempsRestant" class="text-primary">--:--</h4>
                                    </div>
                                    <div class="col-4">
                                        <h6>Prochaine pause</h6>
                                        <h4 id="prochainePause" class="text-warning">--:--</h4>
                                    </div>
                                    <div class="col-4">
                                        <h6>Progression</h6>
                                        <h4 id="progression" class="text-success">0%</h4>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label>Progression du trajet</label>
                                <div class="progress">
                                    <div id="progressBarTrajet" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label>Prochaine pause</label>
                                <div class="progress">
                                    <div id="progressBarPause" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                <button id="stopBtn" class="btn btn-danger">
                                    <i class="fas fa-stop me-2"></i>Arrêter le Trajet
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/locales/bootstrap-datepicker.fr.min.js"></script>

    <script>
        // Configuration BLE
        const SERVICE_UUID = '12345678-1234-1234-1234-123456789abc';
        const CHAR_UUID = '12345678-1234-1234-1234-123456789abd';
        
        let device, server, service, characteristic;
        let isConnected = false;
        let trajetActif = false;

        // Base de données simplifiée des villes françaises
        const villesFrance = [
            "Paris", "Marseille", "Lyon", "Toulouse", "Nice", "Nantes", "Strasbourg", "Montpellier",
            "Bordeaux", "Lille", "Rennes", "Reims", "Le Havre", "Saint-Étienne", "Toulon", "Grenoble",
            "Dijon", "Angers", "Nîmes", "Villeurbanne", "Le Mans", "Aix-en-Provence", "Clermont-Ferrand",
            "Brest", "Limoges", "Tours", "Amiens", "Perpignan", "Metz", "Besançon"
        ];

        $(document).ready(function() {
            initializeApp();
            setupEventListeners();
            updateHeureArriveeParDefaut();
        });

        function initializeApp() {
            // Configuration de l'heure d'arrivée par défaut
            $('#heureArrivee').val(getDefaultArrivalTime());
            
            // Initialisation de l'autocomplétion
            initAutocomplete('#villeDepart', villesFrance);
            initAutocomplete('#villeArrivee', villesFrance);
        }

        function setupEventListeners() {
            // Connexion BLE
            $('#connectBtn').click(connectBLE);
            
            // Envoi des données
            $('#trajetForm').on('submit', function(e) {
                e.preventDefault();
                sendTrajetData();
            });
            
            // Arrêt du trajet
            $('#stopBtn').click(stopTrajet);
            
            // Mise à jour automatique de l'heure d'arrivée
            $('#totalTime').on('change', updateHeureArriveeEstimee);
        }

        function initAutocomplete(selector, data) {
            $(selector).on('input', function() {
                const valeur = $(this).val().toLowerCase();
                const autoCompleteId = selector === '#villeDepart' ? '#autoCompleteDepart' : '#autoCompleteArrivee';
                const $autoComplete = $(autoCompleteId);
                
                $autoComplete.empty();
                
                if (valeur.length > 1) {
                    const resultats = data.filter(ville => 
                        ville.toLowerCase().includes(valeur)
                    ).slice(0, 8);
                    
                    resultats.forEach(ville => {
                        $autoComplete.append(
                            `<div class="auto-complete-item" data-ville="${ville}">${ville}</div>`
                        );
                    });
                    
                    if (resultats.length > 0) {
                        $autoComplete.show();
                    } else {
                        $autoComplete.hide();
                    }
                } else {
                    $autoComplete.hide();
                }
            });
            
            // Sélection d'une ville
            $(document).on('click', `${selector} ~ .auto-complete-list .auto-complete-item`, function() {
                const ville = $(this).data('ville');
                $(selector).val(ville);
                $(`${selector} ~ .auto-complete-list`).hide();
            });
            
            // Cacher l'autocomplétion en cliquant ailleurs
            $(document).on('click', function(e) {
                if (!$(e.target).closest(selector).length) {
                    $(`${selector} ~ .auto-complete-list`).hide();
                }
            });
        }

        function getDefaultArrivalTime() {
            const now = new Date();
            now.setHours(now.getHours() + 3); // +3 heures par défaut
            return now.toTimeString().slice(0, 5);
        }

        function updateHeureArriveeParDefaut() {
            $('#heureArrivee').val(getDefaultArrivalTime());
        }

        function updateHeureArriveeEstimee() {
            const duree = parseInt($('#totalTime').val()) || 0;
            if (duree > 0) {
                const now = new Date();
                now.setMinutes(now.getMinutes() + duree);
                $('#heureArrivee').val(now.toTimeString().slice(0, 5));
            }
        }

        async function connectBLE() {
            try {
                showLoading('Recherche de dispositifs BLE...');
                
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'ESP32-Dashboard' }],
                    optionalServices: [SERVICE_UUID]
                });
                
                showLoading('Connexion en cours...');
                server = await device.gatt.connect();
                
                showLoading('Récupération du service...');
                service = await server.getPrimaryService(SERVICE_UUID);
                
                showLoading('Récupération de la caractéristique...');
                characteristic = await service.getCharacteristic(CHAR_UUID);
                
                // Écouter les notifications
                await characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                
                isConnected = true;
                updateConnectionStatus(true);
                $('#sendBtn').prop('disabled', false);
                
                hideLoading();
                showToast('Connexion réussie!', 'success');
                
                // Surveillance de la déconnexion
                device.addEventListener('gattserverdisconnected', onDisconnected);
                
            } catch (error) {
                hideLoading();
                console.error('Erreur connexion:', error);
                showToast('Erreur de connexion: ' + error.message, 'error');
            }
        }

        function onDisconnected() {
            isConnected = false;
            updateConnectionStatus(false);
            $('#sendBtn').prop('disabled', true);
            showToast('Déconnecté du dispositif', 'warning');
        }

        function updateConnectionStatus(connected) {
            const $status = $('#connectionStatus');
            if (connected) {
                $status.removeClass('status-disconnected').addClass('status-connected')
                      .html('<i class="fas fa-wifi me-2"></i>Connecté');
            } else {
                $status.removeClass('status-connected').addClass('status-disconnected')
                      .html('<i class="fas fa-plug me-2"></i>Déconnecté');
            }
        }

        async function sendTrajetData() {
            if (!isConnected) {
                showToast('Veuillez d\'abord vous connecter', 'warning');
                return;
            }

            const trajetData = {
                action: 'start',
                total_time: parseInt($('#totalTime').val()),
                pause_freq: parseInt($('#pauseFrequency').val()),
                ville_depart: $('#villeDepart').val(),
                ville_arrivee: $('#villeArrivee').val(),
                distance: $('#distance').val() ? parseInt($('#distance').val()) : null,
                heure_arrivee: $('#heureArrivee').val(),
                timestamp: new Date().toISOString()
            };

            try {
                const encoder = new TextEncoder();
                await characteristic.writeValue(encoder.encode(JSON.stringify(trajetData)));
                
                trajetActif = true;
                updateTrajetDisplay(true);
                showToast('Trajet démarré avec succès!', 'success');
                
            } catch (error) {
                console.error('Erreur envoi:', error);
                showToast('Erreur lors de l\'envoi des données', 'error');
            }
        }

        async function stopTrajet() {
            if (!isConnected) return;
            
            const stopData = {
                action: 'stop',
                timestamp: new Date().toISOString()
            };

            try {
                const encoder = new TextEncoder();
                await characteristic.writeValue(encoder.encode(JSON.stringify(stopData)));
                
                trajetActif = false;
                updateTrajetDisplay(false);
                showToast('Trajet arrêté', 'info');
                
            } catch (error) {
                console.error('Erreur arrêt:', error);
                showToast('Erreur lors de l\'arrêt du trajet', 'error');
            }
        }

        function handleNotifications(event) {
            const value = event.target.value;
            const decoder = new TextDecoder();
            const dataStr = decoder.decode(value);
            
            try {
                const data = JSON.parse(dataStr);
                updateTrajetInfo(data);
            } catch (error) {
                console.log('Notification reçue:', dataStr);
            }
        }

        function updateTrajetInfo(data) {
            if (data.temps_restant !== undefined) {
                $('#tempsRestant').text(formatMinutes(data.temps_restant));
                $('#prochainePause').text(formatMinutes(data.prochaine_pause));
                $('#progression').text(data.progression_trajet + '%');
                
                $('#progressBarTrajet').css('width', data.progression_trajet + '%');
                $('#progressBarPause').css('width', data.progression_pause + '%');
            }
        }

        function updateTrajetDisplay(actif) {
            if (actif) {
                $('#trajetInfo').hide();
                $('#activeTrajet').show();
                $('#sendBtn').html('<i class="fas fa-sync-alt me-2"></i>Mettre à jour');
            } else {
                $('#trajetInfo').show();
                $('#activeTrajet').hide();
                $('#sendBtn').html('<i class="fas fa-paper-plane me-2"></i>Démarrer le Trajet');
            }
        }

        function formatMinutes(minutes) {
            if (minutes >= 60) {
                const heures = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${heures}h${mins.toString().padStart(2, '0')}`;
            }
            return `${minutes}min`;
        }

        function showLoading(message) {
            // Implémentez un spinner de chargement si nécessaire
            console.log('Loading:', message);
        }

        function hideLoading() {
            // Cacher le spinner
        }

        function showToast(message, type = 'info') {
            // Créer un toast Bootstrap
            const toast = $(`
                <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : type} border-0 position-fixed top-0 end-0 m-3" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `);
            
            $('body').append(toast);
            const bsToast = new bootstrap.Toast(toast[0]);
            bsToast.show();
            
            toast.on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }

        // Gestionnaire d'erreurs global
        window.addEventListener('error', function(e) {
            console.error('Erreur globale:', e.error);
            showToast('Une erreur est survenue', 'error');
        });
    </script>
</body>
</html>
