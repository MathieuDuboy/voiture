<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>ESP32 Audio Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: #0f172a;
    color: #e5e7eb;
    margin: 0;
    padding: 20px;
}

h1 {
    text-align: center;
}

.card {
    max-width: 600px;
    margin: auto;
    background: #020617;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 30px rgba(0,0,0,0.5);
}

input, button {
    width: 100%;
    padding: 12px;
    margin: 10px 0;
    border-radius: 8px;
    border: none;
    font-size: 16px;
}

input {
    background: #020617;
    color: white;
    border: 1px solid #334155;
}

button {
    background: #2563eb;
    color: white;
    font-weight: bold;
}

button:disabled {
    background: #334155;
}

.log {
    background: black;
    padding: 10px;
    height: 200px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 13px;
    border-radius: 8px;
    border: 1px solid #334155;
}

.ok { color: #22c55e; }
.err { color: #ef4444; }
.info { color: #38bdf8; }
.warn { color: #facc15; }
</style>
</head>
<body>

<h1>üéß ESP32 WiFi Audio Player</h1>

<div class="card">

<label>üì° IP de l'ESP32 :</label>
<input id="ip" value="10.14.133.45">

<label>üåç URL du fichier audio RAW :</label>
<input id="audioUrl" value="https://mathieuduboy.github.io/voiture/test3.raw">

<button id="btn" onclick="start()">‚ñ∂Ô∏è Envoyer le son</button>

<h3>üìú Logs :</h3>
<div id="log" class="log"></div>

</div>

<script>
const logDiv = document.getElementById("log");
const btn = document.getElementById("btn");

function log(msg, cls="info") {
    const line = document.createElement("div");
    line.className = cls;
    line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logDiv.appendChild(line);
    logDiv.scrollTop = logDiv.scrollHeight;
}

async function start() {
    const ip = document.getElementById("ip").value.trim();
    const audioUrl = document.getElementById("audioUrl").value.trim();

    btn.disabled = true;
    log("üöÄ D√©marrage...", "info");

    try {
        // T√©l√©charger l'audio
        log("‚¨áÔ∏è T√©l√©chargement...", "info");
        const response = await fetch(audioUrl);
        const audioData = await response.arrayBuffer();
        log(`‚úÖ ${audioData.byteLength} bytes`, "ok");
        
        // Envoyer directement sans header complexe
        log("üì° Envoi vers ESP32...", "info");
        
        const xhr = new XMLHttpRequest();
        xhr.open('POST', `http://${ip}:8081`, true);
        xhr.responseType = 'arraybuffer';
        
        xhr.onload = function() {
            log("‚úÖ Transfert termin√©", "ok");
            btn.disabled = false;
        };
        
        xhr.onerror = function() {
            log("‚ùå Erreur r√©seau", "err");
            btn.disabled = false;
        };
        
        xhr.ontimeout = function() {
            log("‚è±Ô∏è Timeout", "warn");
            btn.disabled = false;
        };
        
        xhr.timeout = 10000; // 10 secondes
        xhr.send(audioData);
        
    } catch (e) {
        log(`‚ùå Erreur: ${e.message}`, "err");
        btn.disabled = false;
    }
}
</script>

</body>
</html>
